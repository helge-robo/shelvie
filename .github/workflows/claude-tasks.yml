name: Claude Task

on:
  issues:
    types: [opened, labeled]
  issue_comment:
    types: [created]

jobs:
  handle-task:
    if: |
      contains(github.event.issue.labels.*.name, 'claude') ||
      contains(github.event.comment.body, '@helge-robo')

    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Run Claude
        run: |
          # Get the task from issue body or comment
          TASK="${{ github.event.comment.body || github.event.issue.body }}"

          # Run Claude (already logged in on server)
          claude -p "$TASK" --dangerously-skip-permissions

          # If changes were made, commit and push
          if [[ -n $(git status --porcelain) ]]; then
            git config user.name "helge-robo"
            git config user.email "helge-robo@users.noreply.github.com"
            git add -A
            git commit -m "Task: ${{ github.event.issue.title }}"
            git push
          fi

          # Comment back on the issue
          gh issue comment ${{ github.event.issue.number }} \
            --body "âœ… Done! See commit $(git rev-parse --short HEAD)"e
